# 面向对象设计与构造第二单元任务

> 本次作业的新增内容有：
>
> - 新增双轿厢电梯改造
> - 修改"RECEIVE"约束；修改临时调度约束
>
> 具体内容见指导书对应部分。
>
> 本次作业官方包已放在：http://gitlab.oo.buaa.edu.cn/2025_oo_public/official_package/hw7

## 第一部分：训练目标

- 掌握线程间的交互逻辑与协同设计层次架构。
- 理解调度器的作用与实现的方法。

## 第二部分：题目概况

本单元以某公司大楼的**目的选层电梯系统**为背景。

> 目的选层电梯系统的运行流程：
>
> 1. 进入电梯前，乘客输入目标楼层；
> 2. 系统根据设定的策略指定最合适的电梯来服务，将结果告知乘客；
> 3. 乘客进入指定电梯后，无需再次按楼层按钮，电梯会自动将其送至目标楼层。

与普通的目的选层电梯系统有所区分的是，该公司为提高运行效率，充分考虑不同职位的员工所从事工作的时间急迫性，为不同类型的乘客请求赋予了**优先级指数**。优先级指数描述了乘客到达目的楼层的急迫程度。

在三次迭代作业中，你需要根据需求与正确性约束，设计多线程程序来模拟该电梯系统的运行。

系统从标准输入中读入乘客请求信息（起点层，终点楼层），**请求调度器**会根据此时电梯运行状态将乘客请求合理**分配给某部电梯**。被分配请求的电梯会经过**上下行，开关门，乘客进入/离开电梯**等动作将乘客从起点层运送到终点层。

请求的输入通过**课程组提供的**输入接口来**定时投放**请求，你需要调用课程组提供的接口进行输入输出。接口的具体细节见**第三部分和相关文档**。

**单部电梯的运行策略与电梯系统的调度策略均可任意指定**。也就是说，在任意时刻，电梯的上下行动、开关门操作都可以自定义，只要保证在**电梯系统运行时间不超过题目要求时间上限**的前提下将所有的乘客送至目的地即可。

**自第六次作业起，不再为乘客请求指定负责接送的电梯。**

## 第三部分：输入/输出接口说明

1. 本单元作业**请使用课程组提供的输入输出接口进行输入输出**，见本次作业公开仓库。
2. 输入接口提供了若干方法，通过调用方法可以直接获取所需数据对象。输入接口在**尝试**读取标准输入的内容时，对于正确的输入将成功解析，错误的则输出错误信息，但不会影响程序的正常运行。
3. 输出子程序接受一个字符串，并附上时间戳后再输出。
4. **详细的接口定义和使用方法见接口说明文档。**
5. 程序的输入输出为**实时交互**，评测机可以做到在某个时间点投放一定量的输入。
6. **不需要考虑由于调用输入输出接口导致的时间上的差异**，可以认为**准时**投放请求和输出相关内容。
7. **不需要对输入输出接口进行修改**。

## 第四部分：临时调度

### 功能描述

出于按需要检修电梯系统的需要，有时人工会介入电梯调度，要求电梯尽快到达某一楼层：这一过程称为**临时调度**。

电梯到达目标楼层后，需要保持开门Tstop=1s，在关门并输出电梯临时调度完成后才能重新参与电梯系统内的调度，进行开关门、乘客进出、移动等操作。

### 输入输出格式

#### 输入格式

每次临时调度的请求格式如下：`[时间戳]SCHE-电梯ID-临时运行速度-目标楼层`

#### 输出格式

- 电梯接收到临时调度请求：`[时间戳]SCHE-ACCEPT-电梯ID-临时运行速度-目标楼层`（该消息由官方包自动输出，同学无需输出）
- 电梯开始临时调度：`[时间戳]SCHE-BEGIN-电梯ID`
- 电梯临时调度完成：`[时间戳]SCHE-END-电梯ID`

### 正确性约束

- 未接收到临时调度指令的电梯**不得进行临时调度**，**不得修改电梯运行参数**，以免造成评测错误。

- 接收到临时调度指令的电梯必须在

  两次移动楼层操作内

  输出

  ```
  SCHE-BEGIN-电梯ID
  ```

  开始临时调度动作。

  - “在两次移动楼层操作内”指的是在官方包自动输出`SCHE-ACCEPT`开始，该部电梯在输出`SCHE-BEGIN-电梯ID`之前至多输出两条`ARRIVE`。

- `SCHE-ACCEPT`和`SCHE-END`之间的时间记为响应时间Tcomplete*T**c**o**m**p**l**e**t**e*，Tcomplete*T**c**o**m**p**l**e**t**e***不得超过6s**。

- 输出`SCHE-BEGIN-电梯ID`时必须保证电梯轿厢的门**处于关闭状态**。

- 电梯接受`SCHE-BEGIN-电梯ID`时，应**静止在某一楼层**，而非在移动过程中接受`SCHE`请求。

- 输出`SCHE-BEGIN-电梯ID`后，电梯开始**以指定的临时运行速度**移动到指定的目标楼层，移动过程中不能开关门；电梯移动过程中，轿厢内**可以有乘客**。

- 到达目标楼层后，电梯应开门并保持Tstop*T**s**t**o**p*时间，以完成临时调度动作；在开门Tstop*T**s**t**o**p*时间后，才可以**按次序**输出关门标志（`[时间戳]CLOSE-所在层-电梯ID`）和临时调度结束标志（`SCHE-END-电梯ID`）。

- 到达目标楼层、电梯开门后，轿厢

  只下不上

  。

  - **若乘客的目标楼层在电梯当前所在楼层（即电梯的目标楼层），乘客离开电梯视为乘客到达目标楼层**。
  - 其他乘客离开电梯视为未到达目标楼层，仍然需要重新调度电梯接送。
  - 输出临时调度结束标志（`SCHE-END-电梯ID`）时，必须保证**电梯轿厢没有人，且门是关闭的**。

- 除上一条约束所述乘客可在电梯到达目标楼层后离开电梯的情况外，在输出`SCHE-BEGIN-电梯ID` 和输出`SCHE-END-电梯ID`之间，电梯不得参与电梯调度，即电梯在完成临时调度期间不能进出乘客、输出RECEIVE（见`RECEIVE`约束）、在到达目标楼层前不能开关门等，处于**静默状态**。

- 完成临时调度动作后，电梯位于临时调度请求指定的目标楼层，运行速度恢复到默认值（`0.4s/层`）。

### 数据限制

#### 基本限制

- 输入保证在程序逻辑正确的前提下，进行临时调度操作的电梯已存在于当前电梯系统中。
- **在电梯合理运行的情况下，保证电梯在下次收到SCHE请求前可以完成上个SCHE请求。**
- 保证两个相邻的`SCHE`请求之间的时间不少于8s。
- 目标楼层∈B2,B1,F1,F2,F3,F4,F5。
- 临时运行速度∈0.2,0.3,0.4,0.5。

#### 公测数据限制

临时调度指令数不超过**20**条。

#### 互测数据限制

- 一部电梯最多只能进行一次临时调度。
- 第一条指令的投喂时间在1s或1s以后。
- 最后一条指令的输入时间不晚于50s。
- 随测试点提交的输出合法。

> 想一想：
>
> - 中途下电梯的乘客和从起始位置出发的乘客对程序而言有区别吗？
> - 临时调度请求是否可以认为是电梯运行逻辑中的一个动作（类似开关门、上下行）？

## 第五部分：双轿厢改造

### 功能描述

为配合大楼施工改造，部分电梯井无法使用，为了充分利用空余的轿厢，可将轿厢安排到其他可用的电梯井中。此时在同一电梯井道内同时拥有两个独立的电梯轿厢，可达到同时利用高层与底层的空闲电梯井资源的目标。

**为了简化问题，我们省略了两部轿厢移动到初始位置的过程，即改造结束后，可认为两部轿厢已“闪现”到初始位置。**

### 输入输出格式

#### 输入格式

每次双轿厢改造请求的输入格式如下：`[时间戳]UPDATE-A电梯ID-B电梯ID-目标楼层`

例子：`[时间戳]UPDATE-2-4-F2`，指将2号电梯井道的轿厢（即2号电梯），移动到4号电梯井道中。

#### 输出格式

- 电梯系统接收到改造请求：`[时间戳]UPDATE-ACCEPT-A电梯ID-B电梯ID-目标楼层`（该消息由官方包自动输出，同学无需输出）
- 双轿厢系统开始改造：`[时间戳]UPDATE-BEGIN-A电梯ID-B电梯ID`
- 双轿厢系统改造完成：`[时间戳]UPDATE-END-A电梯ID-B电梯ID`
- 注意：对于一条双轿厢改造请求，**只输出一条对应 BEGIN 行和一条对应的 END 行。**

### 正确性约束

- 未接收到改造指令的电梯**不得进行改造**，不得修改运行参数，以免造成评测错误。

- 接收到改造指令的两部电梯必须在两次移动楼层操作内将所有乘客放出，并在两部电梯都停下后输出

  ```
  UPDATE-BEGIN
  ```

  就地开始改造动作

  - “在两次移动楼层操作内”指的是在官方包自动输出`UPDATE-ACCEPT`开始之后，输出`UPDATE-BEGIN`之前**分别**至多输出两条`ARRIVE`。
  - 接收到改造指令后**尽快**完成改造动作,`UPDATE-ACCEPT`和`UPDATE-END`之间的时间记为响应时间Tcomplete,Tcomplete不得超过6s。

- 电梯输出`UPDATE-BEGIN`时必须保证**两个电梯轿厢内没有人**，且**门是关闭的**。

- 电梯改造过程需要时间Treset=1s，即`UPDATE-BEGIN`和`UPDATE-END`之间至少间隔Treset长度的时间。

- 输出`UPDATE-BEGIN` 和输出`UPDATE-END`之间电梯不得参与电梯调度，即不能开关门、进出乘客、上下楼层、输出RECEIVE（见`RECEIVE`约束）等，处于**静默状态**。

- 完成改造后，

  - **原A电梯对应的井道停止使用**，其中没有电梯轿厢可供调度。
  - 在B电梯对应的电梯井中，初始状态下B电梯位于换乘楼层的下面一层，A电梯位于换乘楼层的上面一层。
  - 例：`[时间戳]UPDATE-2-4-F2`，指将2号电梯井道的轿厢（即2号电梯），移动到4号电梯井道中。移动完成后，2号电梯在F3层，4号电梯在F1层。
  - 在B电梯对应的电梯井中，两部轿厢可独立运行，但需要注意轿厢分别的**运行范围**：A 电梯运行范围为 `目标楼层 ~ F7`，B 电梯运行范围为 `B4 ~ 目标楼层`；**不能出现**同时位于同一楼层、B 电梯位于 A 电梯上方等运行冲突导致两部电梯相撞的行为。
  - 两部轿厢的运行速度均提升至 `0.2s/层`。
  - 双轿厢电梯（A 电梯和 B 电梯）可以不受 RECEIVE 约束而**从目标楼层移动一层以离开目标楼层**。

### 数据限制

#### 基本限制

- **不保证**改造后电梯性能更优或更劣。
- 一部电梯最多进行一次到双轿厢系统的改造。
- **保证改造为双轿厢的两部电梯不会再接收到改造请求或临时调度请求**。
- 保证两个相邻的`SCHE`请求与`UPDATE`请求之间的时间不少于8s。
- 保证在正常完成临时调度请求的情况下，电梯不会在临时调度请求执行期间收到改造请求。
- 目标楼层 ∈B2,B1,F1,F2,F3,F4,F5。

> 想一想：对于双轿厢电梯，是否总可以通过两个轿厢的协作完成**任意**请求？

#### 互测数据限制

- 第一条指令的投喂时间在1s或1s以后。
- 最后一条指令的输入时间不晚于50s。
- 随测试点提交的输出合法。

## 第六部分：电梯运行

### 功能描述

对于每个乘客请求（起点层，终点层），需要调度电梯将其完成，并将必要的运行信息通过输出接口进行输出。

具体而言，你需要控制电梯**上下行，开关门的动作**以及**控制乘客进出电梯**来将乘客从起点层运送到终点层。

自第六次作业起，**负责接送乘客请求的电梯可任意指定**。你需要设计合适的调度策略来合理调度策略，在完成接送任务的同时达到更好的性能。

### 输入输出格式

#### 输入格式

每个乘客的请求格式如下：`[时间戳]乘客ID-PRI-优先级指数-FROM-起点层-TO-终点层`

#### 输出格式

通过调用输出接口的每一次输出将自动附加时间戳于头部，具体请参考**输出接口文档**。

请**不要试图伪造时间戳**，否则会在实际评测时产生不一样的结果导致程序运行错误，由此产生的结果自行承担。

- 电梯到达某一位置：`[时间戳]ARRIVE-所在层-电梯ID`
- 电梯开始开门：`[时间戳]OPEN-所在层-电梯ID`
- 电梯完成关门：`[时间戳]CLOSE-所在层-电梯ID`
- 乘客进入电梯：`[时间戳]IN-乘客ID-所在层-电梯ID`
- 乘客离开电梯：
  - 如果乘客已到达目标楼层：`[时间戳]OUT-S-乘客ID-所在层-电梯ID`
  - 否则：`[时间戳]OUT-F-乘客ID-所在层-电梯ID`

### 正确性约束

电梯系统默认参数如下：

- 可到达楼层：地下B4-B1层，地上F1-F7层，共11层
- 初始位置：F1层
- 数量：6部
- 编号：6部电梯的`id`依次为1-6
- 移动速度：0.4s/层
- 限制乘坐人数：6人
- 开关门：开门到关门之间的间隔不小于0.4s

系统运行时需满足以下约束：

- 电梯在两层楼之间移动应满足移动时间约束
- 电梯只能在大楼的楼层范围内移动
- 初始时所有电梯为关门状态，开门状态下才能关门，关门状态下才能开门
- 电梯移动时，必须处于关门状态
- 一次`ARRIVE`输出表示电梯移动一层，电梯不可一次移动多层
- 程序运行结束时所有电梯必须处于关门状态
- 乘客默认不在电梯里，电梯开门状态下才能进出电梯，且只能进入同层的电梯
- 乘客只有在电梯内才能出电梯，只有在电梯外才能进电梯
- 开门状态下乘客进出电梯不花费时间
- **运行时的任意时刻需满足轿厢容量限制以及输出时间戳非减限制**
- **系统结束时不可以有乘客请求未完成或乘客困在电梯里的情况出现**
- 系统运行中乘客可以中途下电梯，系统结束时到达目的地即可
- 系统运行时间不得大于时间上限Tmax*，Tmax*的定义见**公测数据限制**

## 第七部分：乘客优先级指数

### 功能描述

每个乘客请求都附有对应的**优先级指数**，用来表示该乘客到达目标楼层的急迫程度。

### 输入输出格式

见第六部分。

### 正确性约束

只要保证在**电梯系统运行时间不超过题目要求时间上限**的前提下，将所有的乘客送至目的地即可。

也就是说，优先级指数**不涉及程序的正确性约束**，而是与性能分相关。

### 数据限制

- 每个乘客请求具有唯一的`id`，`id`为`int`范围内的一个正整数。
- 优先级指数为一个**不大于100的正整数**。优先级指数越大，表示该乘客请求到达目标楼层的急迫性越强。

## 第八部分：RECEIVE约束

### 一、功能描述

为避免出现多部电梯接送同一乘客造成资源浪费的情况，自本次作业起引入RECEIVE约束，请将`RECEIVE`作为调度器的**附加输出**来说明自己的分配方案，边界情况见**正确性说明**。

### 二、输入输出格式

#### 输出格式

电梯接收分配：`[时间戳]RECEIVE-乘客ID-电梯ID`

### 三、正确性说明

你的程序需要在**乘客进入电梯**和**电梯移动**前输出`RECEIVE`来说明乘客请求分配情况。

- 乘客只能在**电梯外**才可以有相关RECEIVE输出（**注意OUT、IN和RECEIVE的输出顺序**）
- **任何时刻任何一个乘客请求都至多会被分配给一部电梯**，乘客**只能**进入RECEIVE输出规定的电梯。
- 电梯内没有乘客时，只有`RECEIVE`到某个乘客请求，或收到并开始进行`SCHE`操作后，电梯才能**开始移动**。

```java
    示例1：
    [   0.0010]2-FROM-B2-TO-F7 ← 输入
    [   0.4080]ARRIVE-B1-1     ← 1号电梯为空电梯且未RECEIVE到任何乘客，移动不合法！
    示例2：
    [   0.0010]2-FROM-B2-TO-F7 ← 输入
    [   0.0280]RECEIVE-2-2    ← 2号电梯RECEIVE到2号乘客
    [   0.4310]ARRIVE-B1-2     ← 2号电梯移动合法！
    示例3：
    [   0.0010]2-FROM-B2-TO-F7 ← 输入
    [   0.0280]RECEIVE-2-2    ← 2号电梯RECEIVE到2号乘客
    [   0.0340]RECEIVE-2-3    ← 同一个乘客同时分配给了两个电梯，不合法！
    示例4：
    [   1.0150]RECEIVE-10-1
    [   1.0170]ARRIVE-B1-1    ← ARRIVE标记的是到达状态，假设此时电梯运行速度是每层0.4s，在0.6170s时电梯尚未收到RECEIVE，无法移动，不合法！
```

#### RECEIVE取消

RECEIVE取消指的是在一定情况下，某个**电梯外的**乘客不再被认为分配给某部电梯，该电梯的移动约束和该乘客进入电梯的约束见**正确性说明**。

`RECEIVE`被取消**当且仅当**以下三种情况 **（有新增）**：

- 电梯**开始双轿厢升级**后，其**之前与两部电梯**有关的`RECEIVE`全部自动取消。也即`[时间戳]UPDATE-BEGIN-电梯ID`输出后，之前仍有效的`RECEIVE-乘客ID-电梯ID`全部取消，相关乘客处于未分配状态，**电梯也视为未RECEIVE到任何乘客**。
- 电梯**开始临时调度**后，其**之前与此电梯**有关的`RECEIVE`全部自动取消。也即`[时间戳]SCHE-BEGIN-电梯ID`输出后，之前仍有效的`RECEIVE-乘客ID-电梯ID`全部取消，相关乘客处于未分配状态，**电梯也视为未RECEIVE到任何乘客**。
- 乘客**离开**电梯后，相应的`RECEIVE`被取消。也即`[时间戳]OUT-{S|F}-乘客ID-所在层-电梯ID`输出后，**最近一个**`RECEIVE-乘客ID-电梯ID`视作完成。

举例说明：

```java
  示例 1：
  [   4.6280]RECEIVE-2-1
  ....                      ← 2号乘客进入1号电梯，1号电梯开关门移动等动作输出
  [   6.8280]OUT-F-2-F4-1
  [   6.9430]RECEIVE-2-2    ← 乘客走出1号电梯，上个RECEIVE被取消，合法输出！
  [   6.9670]IN-2-F4-2       ← 有2号乘客和2号电梯的RECEIVE输出，2号乘客可以进入2号电梯

  示例 2：
  [   4.6280]RECEIVE-1-2
  [   4.6290]RECEIVE-2-2
  [   4.6296]RECEIVE-3-2      
  [   4.9670]OPEN-F4-2
  [   5.3360]IN-1-F4-2       ← 1号乘客进入2号电梯
  [   5.3370]IN-3-F4-2       ← 3号乘客进入2号电梯      
  [   5.3360]CLOSE-F4-2 
  ....                      ← 一些中间输出，1号和3号乘客已进入2号电梯，2号乘客此时还**未进入**2号电梯
  [   6.5630]SCHE-ACCEPT-2-F3-0.5
  [   6.6430]RECEIVE-3-3    ← 3号乘客此时在电梯内，不可以输出RECEIVE，不合法！   
  [   6.7640]OPEN-F3-2
  [   6.7650]OUT-F-1-F3-2
  [   6.7660]OUT-F-3-F3-2
  [   7.1950]CLOSE-F3-2 
  [   7.2160]RECEIVE-1-3    ← 由于1号乘客乘客走出了1号电梯，合法输出！ 
  [   7.2170]SCHE-BEGIN-2    
  [   7.2180]RECEIVE-2-5    ← 有2号电梯的SCHE-BEGIN，旧的RECEIVE被取消，合法输出！  
```

## 第九部分：样例

| 序号 | 输入                                                         | 输出                                                         |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | [3.7]UPDATE-4-2-F5<br />[3.7]UPDATE-1-5-F1 <br />[3.7]UPDATE-3-6-F5 <br />[6.0]318-PRI-17-FROM-F7-TO-B3 | [ 3.8700]UPDATE-ACCEPT-4-2-F5 <br />[ 3.8710]UPDATE-ACCEPT-1-5-F1 <br />[ 3.8720]UPDATE-ACCEPT-3-6-F5 <br />[ 3.8720]UPDATE-BEGIN-1-5 <br />[ 3.8720]UPDATE-BEGIN-4-2<br />[ 3.8720]UPDATE-BEGIN-3-6 <br />[ 4.8770]UPDATE-END-4-2 <br />[ 4.8770]UPDATE-END-3-6 <br />[ 4.8770]UPDATE-END-1-5 <br />[ 6.8230]RECEIVE-318-4 <br />[ 7.0230]ARRIVE-F7-4 <br />[ 7.0230]OPEN-F7-4 <br />[ 7.0230]IN-318-F7-4 <br />[ 7.4320]CLOSE-F7-4 <br />[ 7.6370]ARRIVE-F6-4 <br />[ 7.8440]ARRIVE-F5-4 <br />[ 7.8440]OPEN-F5-4 <br />[ 7.8440]OUT-F-318-F5-4 <br />[ 7.8440]RECEIVE-318-4 <br />[ 8.2570]CLOSE-F5-4 <br />[ 8.2570]OPEN-F5-4 <br />[ 8.2570]IN-318-F5-4 <br />[ 8.6690]CLOSE-F5-4 <br />[ 8.6690]OPEN-F5-4 <br />[ 8.6690]OUT-F-318-F5-4 <br />[ 8.6690]RECEIVE-318-1<br /> [ 8.8730]ARRIVE-F3-1 <br />[ 9.0780]CLOSE-F5-4 <br />[ 9.0780]ARRIVE-F4-1 <br />[ 9.2820]ARRIVE-F6-4<br /> [ 9.2820]ARRIVE-F5-1 <br />[ 9.2820]OPEN-F5-1 <br />[ 9.2820]IN-318-F5-1 <br />[ 9.6930]CLOSE-F5-1 <br />[ 9.8990]ARRIVE-F4-1 <br />[ 10.1060]ARRIVE-F3-1 <br />[ 10.3110]ARRIVE-F2-1<br /> [ 10.5190]ARRIVE-F1-1 <br />[ 10.5190]OPEN-F1-1 <br />[ 10.5190]OUT-F-318-F1-1 <br />[ 10.8490]RECEIVE-318-5 <br />[ 10.9290]CLOSE-F1-1 <br />[ 11.1360]ARRIVE-F2-1 <br />[ 11.1360]ARRIVE-F1-5 <br />[ 11.1360]OPEN-F1-5 <br />[ 11.1360]IN-318-F1-5<br />[ 11.5480]CLOSE-F1-5 <br />[ 11.7540]ARRIVE-B1-5 <br />[ 11.9600]ARRIVE-B2-5 <br />[ 12.1670]ARRIVE-B3-5 <br />[ 12.1670]OPEN-B3-5 <br />[ 12.1670]OUT-S-318-B3-5 <br />[ 12.5740]CLOSE-B3-5 |

### 警示

**不要试图Hack评测机，不要伪造时间戳，不要抄袭（包括我的、本届与所有往届代码）**。如发现其他人的代码疑似存在上述行为，可向课程组举报。课程组感谢同学们为课程建设所作出的贡献。
